# Phase 2 â€” UI/UX Specification

**Date:** 2026-02-06
**Status:** Draft

---

## 1. Overview

Phase 2 focuses on two axes:

1. **Metro-style DAG visualization** as the core visual identity of SpeedFog Racing
2. **UI/UX overhaul** of the homepage and race detail page, with role-aware views and state-driven layouts

The DAG is the centerpiece: it appears on the homepage as an animated hero element, on race pages as a blurred teaser or live tracker, and on results as the definitive race replay.

---

## 2. DAG Visualization

### 2.1 Technology

**Option A (chosen): Pure SVG with Svelte + custom layout algorithm.**

- No external dependencies (no D3, no dagre)
- Layout algorithm exploits the known structure of SpeedFog DAGs (layered, with splits and merges)
- Svelte components generate SVG elements (`<line>`, `<circle>`, `<path>`)
- CSS animations for drawing effects and player movement
- GPU-accelerated via CSS transforms

Rationale: SpeedFog DAGs are layered graphs with predictable topology (not arbitrary graphs). A custom algorithm tailored to this structure produces better metro-style output than generic layout libraries, with zero bundle cost.

### 2.2 Data Model (graph.json v3)

The current `graph.json` (v2) described zone-level connections for the mod. The v3 format adds node-level data required for the DAG visualization. The speedfog generator already produces v3.

**New fields in graph.json:**

```json
{
  "version": "3.0",
  "seed": 971565517,
  "total_layers": 12,
  "total_nodes": 18,
  "total_paths": 6,
  "nodes": {
    "chapel_start_4f96": {
      "type": "start",
      "display_name": "Chapel of Anticipation",
      "zones": ["chapel_start"],
      "layer": 0,
      "tier": 1,
      "weight": 1
    },
    "dragonbarrow_cave_3b1c": {
      "type": "mini_dungeon",
      "display_name": "Dragonbarrow Cave",
      "zones": ["dragonbarrow_cave"],
      "layer": 1,
      "tier": 3,
      "weight": 4
    }
  },
  "edges": [
    { "from": "chapel_start_4f96", "to": "dragonbarrow_cave_3b1c" },
    { "from": "chapel_start_4f96", "to": "caelid_abandonedcave_aa21" }
  ],
  "connections": [],
  "area_tiers": {}
}
```

`connections` and `area_tiers` remain unchanged for mod compatibility.

### 2.3 Node Types and Station Styles

Each node type maps to a distinct metro station visual:

| Node type        | Metro analogy        | Shape                    | Size   | Example                |
| ---------------- | -------------------- | ------------------------ | ------ | ---------------------- |
| `start`          | Terminus (departure) | Circle + start marker    | Large  | Chapel of Anticipation |
| `mini_dungeon`   | Standard station     | Filled circle            | Small  | Dragonbarrow Cave      |
| `boss_arena`     | Interchange          | Circle with thick border | Medium | Nokron Gargoyles       |
| `major_boss`     | Zone station         | Diamond / rotated square | Large  | Maliketh, Castle Sol   |
| `legacy_dungeon` | Major station (RER)  | Double circle (ring)     | Large  | Stormveil, Academy     |
| `final_boss`     | Terminus (arrival)   | Circle + end marker      | Large  | Erdtree                |

### 2.4 Metro Layout Algorithm

**Input:** nodes (with layer) and edges from graph.json v3.

**Layout rules:**

1. **X-axis:** determined by layer number. Spacing between layers is proportional to the weight of the source node (a legacy*dungeon with weight 23 creates a wider gap \_after* it than a boss_arena with weight 2). The gap is after the station, representing the time spent traversing that dungeon before reaching the next one. Example: chapel_start (w:1) â†’ short gap â†’ academy (w:12) â†’ long gap â†’ next node.
2. **Y-axis:** nodes within the same layer are spread vertically. Barycenter heuristic to minimize edge crossings.
3. **Edges:** drawn as horizontal + 45-degree diagonal segments (metro convention). No curves, no arbitrary angles.
4. **Branch coloring:** each path through the DAG could get its own color (like metro lines), or a single gold/purple accent. TBD during implementation.

### 2.5 DAG Visibility Matrix

Complete role Ã— state matrix. "Real" = actual graph_json from seed. "Fake" = procedurally generated, blurred.

| Race state   | Anonymous spectator | Logged-in spectator | Participant   | Organizer (participating) | Organizer (non-participating) | Caster           |
| ------------ | ------------------- | ------------------- | ------------- | ------------------------- | ----------------------------- | ---------------- |
| **Draft**    | Fake, blurred       | Fake, blurred       | Fake, blurred | Fake, blurred             | Real                          | Real             |
| **Open**     | Fake, blurred       | Fake, blurred       | Fake, blurred | Fake, blurred             | Real                          | Real             |
| **Running**  | Real + positions    | Real + positions    | Fake, blurred | Fake, blurred             | Real + positions              | Real + positions |
| **Finished** | Real + paths        | Real + paths        | Real + paths  | Real + paths              | Real + paths                  | Real + paths     |

Key rules:

- Participants and participating organizers **never** see the real DAG until the race is finished
- Non-participating organizers and casters **always** see the real DAG
- Anonymous/logged-in spectators see the real DAG only once the race starts running
- Once a race is finished, everyone sees everything

### 2.6 Fake Blurred DAG

To prevent spoilers, anyone without DAG access sees a **fake DAG** with CSS blur.

- Generated **client-side** from the meta-stats sent by the server (`total_layers`, `total_nodes`, `total_paths`) â€” not from the actual seed, to avoid leaking information
- The server does NOT send `graph_json` to unauthorized clients
- The algorithm creates a plausible layered graph with random splits and merges calibrated to the meta-stats. It does not need to be deterministic or persistent across renders â€” it's only a blurred silhouette
- The fake DAG only needs to have a plausible shape when blurred
- Displayed with `filter: blur(8px)` and `pointer-events: none`

### 2.7 Homepage Hero Animation

Two-phase animation on page load:

1. **Drawing phase** (0â€“2s): metro lines trace progressively left-to-right, layer by layer. Stations appear as lines reach them. Technique: SVG `stroke-dasharray` + `stroke-dashoffset` CSS animation.
2. **Racing phase** (looping): 3â€“4 colored dots traverse the DAG at different speeds, taking different paths. One finishes first, another gets overtaken. Technique: SVG `<animateMotion>` along paths, or JS keyframe animation for more control (pauses when "exploring" a zone).

---

## 3. Data Model Changes

### 3.1 New Table: `Caster`

Relation between a race and a user acting as caster.

```python
class Caster(Base):
    __tablename__ = "casters"
    __table_args__ = (UniqueConstraint("race_id", "user_id", name="uq_casters_race_user"),)

    id: Mapped[uuid.UUID]  # PK
    race_id: Mapped[uuid.UUID]  # FK -> races.id
    user_id: Mapped[uuid.UUID]  # FK -> users.id
```

A caster has:

- Access to the real DAG (same as non-playing organizer)
- Their Twitch channel displayed to spectators (via `User.twitch_username`)
- Easy access to OBS overlay links on the race page

**Constraint:** a user cannot be both a participant and a caster for the same race. The server rejects adding a caster who is already a participant (and vice versa).

API response schema:

```python
class CasterResponse(BaseModel):
    id: uuid.UUID
    user: UserSummary  # { id, twitch_username, twitch_display_name, twitch_avatar_url }
```

Added to `RaceDetailResponse`:

```python
class RaceDetailResponse(BaseModel):
    # ...existing fields...
    casters: list[CasterResponse]
```

### 3.2 Organizer Participation

`organizer_participates` is a **request-only field** on `POST /api/races`, not stored on the Race model. When `true`, the server auto-creates a `Participant` record for the organizer during race creation.

The server determines whether the organizer is participating by checking for a Participant record matching `race.organizer_id`. This derived check is used for DAG visibility (Section 2.5): the organizer sees the real DAG only if they are NOT a participant.

**Irreversibility rule:** a non-participating organizer has seen the real DAG from the moment of race creation. Therefore, they cannot later add themselves as a participant â€” this would let them race with foreknowledge of the graph. Enforcement: the server rejects `POST /api/races/{id}/participants` when the target user is the organizer and no Participant record already exists for them (i.e., they chose "organize only" at creation).

### 3.3 Relationships Update

```python
class Race(Base):
    # ...existing...
    casters: Mapped[list["Caster"]] = relationship(
        back_populates="race", cascade="all, delete-orphan"
    )

class User(Base):
    # ...existing...
    caster_roles: Mapped[list["Caster"]] = relationship(back_populates="user")
```

### 3.4 Zone Traversal History

To reconstruct each player's path through the DAG on the finished race screen, the server stores the sequence of nodes visited by each participant.

New JSON field on `Participant`:

```python
class Participant(Base):
    # ...existing...
    zone_history: Mapped[list | None] = mapped_column(JSON, nullable=True, default=None)
```

`zone_history` is a list of `{ "node_id": str, "igt_ms": int }` entries, appended server-side each time a `zone_entered` message is received from the mod. The server maps `to_zone` from the message to the corresponding DAG node (by looking up which node contains that zone in its `zones` list from `graph_json`).

This data is included in the `race_state` message for finished races, allowing the frontend to overlay each player's actual path on the DAG.

---

## 4. New API Endpoints

### 4.1 User Search (autocomplete)

```
GET /api/users/search?q={query}
```

- Returns users whose `twitch_username` or `twitch_display_name` matches the query (case-insensitive prefix search)
- Max 10 results
- Requires authentication
- Response: `[{ id, twitch_username, twitch_display_name, twitch_avatar_url }]`

### 4.2 Caster Management

```
POST /api/races/{id}/casters
Body: { "twitch_username": "castername" }
```

- Adds a caster to the race
- The user **must already have an account** (no invite link mechanism for casters, unlike participants)
- Returns 404 if the Twitch username is not found in the database
- Organizer only
- Can be done at any race status

```
DELETE /api/races/{id}/casters/{caster_id}
```

- Removes a caster from the race (by `Caster.id`, consistent with participant deletion pattern)
- Organizer only

### 4.3 Race Creation Update

```
POST /api/races
Body: {
  "name": "Sunday Showdown",
  "pool_name": "standard",
  "organizer_participates": true,
  "config": {
    "max_participants": 8,
    "show_finished_names": true,
    "countdown_seconds": 10
  }
}
```

New request-only field: `organizer_participates`. When `true`, the server auto-creates a Participant record for the organizer. This field is not stored on the Race model (see Section 3.2).

---

## 5. Homepage

### 5.1 Non-Connected User

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SpeedFog Racing                            [Login with Twitch] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                 â”Œâ”€ HERO: ANIMATED DAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                 â”‚                                      â”‚        â”‚
â”‚                 â”‚   â—â”â”â—â”â”â—â”â”â—â”â”â—â”â”â—â”â”â—                â”‚        â”‚
â”‚                 â”‚  â•±    â—†     â•²       â•²                â”‚        â”‚
â”‚                 â”‚ â—     â†‘p1    â—â”â”â—‡â”â”â—â”â—â”â”â— END       â”‚        â”‚
â”‚                 â”‚  â•²    â†‘p2  â•±       â•±                â”‚        â”‚
â”‚                 â”‚   â—â”â”â—â”â”â—â”â”â—â”â”â—â”â”â—â”â”â—                â”‚        â”‚
â”‚                 â”‚                                      â”‚        â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â”‚          Competitive Elden Ring racing through the fog          â”‚
â”‚    Race on randomized worlds. Track progress in real-time.      â”‚
â”‚                                                                 â”‚
â”‚                     [Login with Twitch]                          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ”´ Live Races                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Sunday Showdown  LIVEâ”‚  â”‚ Casual Friday    LIVEâ”‚            â”‚
â”‚  â”‚ 4 players Â· Standard â”‚  â”‚ 3 players Â· Sprint   â”‚            â”‚
â”‚  â”‚ by Roger             â”‚  â”‚ by Someone           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  Upcoming Races                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ Weekly Race    OPEN  â”‚                                      â”‚
â”‚  â”‚ 6/8 players Â· Stnd   â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elements:**

- **Hero DAG** (~40% viewport): animated metro-style DAG from a hand-picked seed. Drawing animation on load, then ghost players racing in a loop. This is the visual identity of SpeedFog Racing.
- **Tagline**: short, punchy, below the DAG.
- **Dual CTA**: "Login with Twitch" in both navbar and hero section.
- **Live Races**: races with status `running`, shown first with animated red dot. Cards display: name, player count, pool type, organizer.
- **Upcoming Races**: races with status `open`. Cards show participant slots (e.g., "6/8 players").
- Draft races are never shown publicly.

### 5.2 Connected User

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SpeedFog Racing          [avatar] Roger  [Create Race] [logout]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€ ACTIVE RACE (if any) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ”´ Sunday Showdown                         LIVE        â”‚    â”‚
â”‚  â”‚  Standard Â· 4 players Â· Layer 6/12                       â”‚    â”‚
â”‚  â”‚  [Spectate]  [Manage]                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  My Races                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Test Race  DRAFTâ”‚ â”‚ Last Week  FIN  â”‚ â”‚ Old Race   FIN  â”‚   â”‚
â”‚  â”‚ Organizing      â”‚ â”‚ Participated    â”‚ â”‚ Organizing       â”‚   â”‚
â”‚  â”‚ 0 participants  â”‚ â”‚ 2nd / 4         â”‚ â”‚ 6 participants   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€ or if no races: â”€â”€                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  No active race.  [Create Race] or browse below          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ Live Races                                                  â”‚
â”‚  (same as non-connected, filtered to exclude user's own)        â”‚
â”‚                                                                 â”‚
â”‚  Upcoming Races                                                 â”‚
â”‚  (same as non-connected)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Differences from non-connected:**

- **No hero DAG**: replaced by actionable dashboard. User already knows the product.
- **Active race spotlight**: if the user has a race in `running` status (as participant, organizer, or caster), it's promoted to a large card with direct CTAs.
- **My Races grid**: horizontal cards sorted by recency. Shows role (Organizing / Participating / Casting), status, and result for finished races (e.g., "2nd / 4").
- **Create Race CTA** in navbar and in empty state.
- Public race sections remain identical, filtered to exclude user's own races.

---

## 6. Race Detail Page

### 6.1 Unified Layout

The page uses a consistent sidebar + main layout across all race states. The sidebar content evolves with the race status, the main area always centers the DAG.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: race name, status badge, elapsed time (if running)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SIDEBAR    â”‚              MAIN AREA                        â”‚
â”‚              â”‚                                               â”‚
â”‚  (evolves   â”‚     DAG (blurred, live, or complete)           â”‚
â”‚   per state) â”‚                                               â”‚
â”‚              â”‚     + contextual info below                   â”‚
â”‚              â”‚                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                               â”‚
â”‚  footer:     â”‚                                               â”‚
â”‚  spectators  â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 State: Draft / Open (Lobby)

**Sidebar:**

```
PARTICIPANTS (3/8)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚[av] Rogerâ”‚
â”‚ â— Ready  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚[av] Aliceâ”‚
â”‚ â—‹ Waitingâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚[av] Bob  â”‚
â”‚ â—‹ Waitingâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œ â”€ â”€ â”€ â”€ â”
  + Invite
â”” â”€ â”€ â”€ â”€ â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† appears when + Invite clicked
â”‚ğŸ” search â”‚     (organizer only)
â”‚ results..â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘ 12 watching
```

- Participant cards with avatar, name, ready state (green dot = mod connected, grey = waiting)
- "+ Invite" dashed card: clickable by organizer, reveals inline search field below it
- Search field with autocomplete: existing users in dropdown, unknown names create invite links
- Ready states update in real-time via WebSocket
- Spectator count at bottom

**Main area:**

- **DAG**: blurred fake (players, spectators) or real (organizer non-player, casters)
- Meta-stats visible in clear below DAG: "12 layers Â· 18 nodes Â· 6 paths"
- **Casters** section: list of caster Twitch channels with links
- **Race info**: pool, created date
- **Actions** (contextual):
  - Participant: "Download Seed Pack" button
  - Organizer: "Manage Race â†’" link

### 6.3 State: Running (Live)

**Sidebar:**

```
LEADERBOARD

1 ğŸ¥‡ Player1
  L8/12
  01:12:30 ğŸ’€3

2    Player2
  L6/12
  01:15:22 ğŸ’€5

3    Player3
  L6/12
  01:18:01 ğŸ’€7

4    Player4
  L4/12
  01:20:15 ğŸ’€2

â— Connected
ğŸ‘ 47 watching
```

- Leaderboard replaces participant list (same sidebar location)
- Each entry: rank, name, layer/total, IGT, death count
- Player colors match their dots on the DAG
- First place gets gold rank marker
- Connection status and spectator count at bottom

**Main area:**

- **Header**: race name, ğŸ”´ LIVE badge, elapsed time (clock)
- **DAG** (spectator/organizer/caster): real metro DAG with colored dots showing live player positions
- **DAG** (player): fake blurred DAG (same as lobby)
- **Casters** section: channels with "ğŸ”´ live" indicator if they are streaming
- **OBS Overlays** links (visible to organizer and casters): "DAG Overlay", "Leaderboard Overlay"

### 6.4 State: Finished (Results)

**Sidebar:**

```
RESULTS

1 ğŸ¥‡ Player1
  01:45:32 ğŸ’€3

2 ğŸ¥ˆ Player2
  01:52:18 ğŸ’€5

3 ğŸ¥‰ Player3
  02:01:45 ğŸ’€7

4    Player4
  DNF (L8/12) ğŸ’€12

[Share] [Copy link]
```

- Final standings with medals for top 3
- DNF for players who didn't finish, showing last layer reached
- Share/copy link buttons

**Main area:**

- **Podium**: visual top-3 display (first place elevated)
- **DAG complete**: real metro DAG visible to everyone, with each player's path overlaid in their color. This is the "replay" â€” players see for the first time the world they just traversed.
- **Race stats**: total duration, average deaths

---

## 7. Race Creation Form

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create Race                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Race Name                                                    â”‚
â”‚  [________________________]                                   â”‚
â”‚                                                               â”‚
â”‚  Seed Pool                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Sprint  â”‚  â”‚ Standard â”‚  â”‚ Marathon â”‚                    â”‚
â”‚  â”‚  ~30min â”‚  â”‚   ~1h    â”‚  â”‚   ~2h    â”‚                    â”‚
â”‚  â”‚         â”‚  â”‚ selected â”‚  â”‚          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                               â”‚
â”‚  Max Participants                                             â”‚
â”‚  [8 â–¾]                                                        â”‚
â”‚                                                               â”‚
â”‚  Will you participate?                                        â”‚
â”‚  (â—) Yes, I'll race    ( ) No, organize only                 â”‚
â”‚                                                               â”‚
â”‚  âš  If you choose "organize only", you will see the DAG       â”‚
â”‚    and cannot join as a player later.                         â”‚
â”‚                                                               â”‚
â”‚  Show finished player names                                   â”‚
â”‚  [âœ“] Yes                                                      â”‚
â”‚                                                               â”‚
â”‚                              [Create Race]                    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Pool selection as visual cards (not a dropdown)
- "Will you participate?" radio with clear warning about DAG visibility implications
- Caster channels are added later via the manage page (not at creation)

---

## 8. Race Management Page Updates

The existing manage page (`/race/{id}/manage`) gains:

### 8.1 Caster Management Section

```
Casters
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œ â”€ â”€ â”€ â”€ â”
â”‚[av] Cast1â”‚  â”‚[av] Cast2â”‚    + Add
â”‚ [Remove] â”‚  â”‚ [Remove] â”‚  â”” â”€ â”€ â”€ â”€ â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ğŸ” search â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Same UI pattern as participant management
- Inline search with autocomplete
- Can be added/removed at any race status

---

## 9. WebSocket Protocol Updates

### 9.1 Spectator WebSocket Authentication (Optional Auth)

The spectator WebSocket at `/ws/race/{race_id}` currently requires no authentication. To support role-based DAG visibility, it gains **optional** message-based authentication, consistent with the mod WebSocket pattern:

1. Client connects to `/ws/race/{race_id}` (no change to URL)
2. If the user is logged in, the frontend sends an `auth` message immediately after connection: `{ "type": "auth", "token": "<api_token>" }`
3. The server validates the token and resolves the user's role (organizer, participant, caster) to determine DAG access
4. If no `auth` message is received within a short grace period (~2s), or if the token is invalid, the connection is treated as anonymous spectator

This is backward-compatible: connections that never send `auth` still work as anonymous spectators. The pattern mirrors the existing mod WebSocket authentication flow.

The server computes a `dag_access` level per connection based on Section 2.5 visibility matrix, and sends the appropriate `race_state` accordingly.

### 9.2 Spectator Count

New message type added to `ServerMessage` union (both backend `schemas.py` and frontend `websocket.ts`):

```json
{ "type": "spectator_count", "count": 47 }
```

Sent when a spectator WebSocket connects or disconnects from the race room. The frontend `RaceStore` gains a `spectatorCount` state field.

### 9.3 DAG Visibility in `race_state`

The `race_state` message's `seed` field becomes role-dependent:

**With DAG access** (per Section 2.5 matrix):

```json
{
  "seed": {
    "total_layers": 12,
    "total_nodes": 18,
    "total_paths": 6,
    "graph_json": { ... }
  }
}
```

**Without DAG access:**

```json
{
  "seed": {
    "total_layers": 12,
    "total_nodes": 18,
    "total_paths": 6,
    "graph_json": null
  }
}
```

`total_nodes` and `total_paths` are read directly from the `graph_json` dict stored on the `Seed` model (alongside the existing `total_layers` field). No additional columns are needed â€” `graph_json` is a Python dict in memory, so accessing `seed.graph_json["total_nodes"]` is a simple dict lookup, not a JSON parse.

When `graph_json` is `null` in the response, the frontend renders the fake blurred DAG using the meta-stats to generate a plausible silhouette (see Section 2.6).

### 9.4 DAG Access Transitions

When a race transitions to `running`, the server re-evaluates DAG access for all connected spectators and sends updated `race_state` messages. Anonymous and logged-in spectators who previously received `graph_json: null` now receive the full `graph_json`.

Same when a race transitions to `finished`: all connected clients (including participants) receive a `race_state` with the full `graph_json` and player paths.

---

## 10. Component Inventory

New or significantly modified Svelte components:

| Component                    | Description                                                    | New/Modified |
| ---------------------------- | -------------------------------------------------------------- | ------------ |
| `MetroDag.svelte`            | SVG metro-style DAG renderer                                   | New          |
| `MetroDagAnimated.svelte`    | Homepage hero variant with drawing + racing animation          | New          |
| `MetroDagBlurred.svelte`     | Fake DAG with blur for non-authorized views                    | New          |
| `MetroDagLive.svelte`        | DAG with real-time player position dots                        | New          |
| `MetroDagResults.svelte`     | DAG with overlaid player paths                                 | New          |
| `Podium.svelte`              | Top-3 visual podium for finished races                         | New          |
| `ParticipantCard.svelte`     | Avatar + name + ready state for lobby sidebar                  | New          |
| `ParticipantSearch.svelte`   | Inline autocomplete search for adding participants/casters     | New          |
| `SpectatorCount.svelte`      | "X watching" indicator                                         | New          |
| `CasterList.svelte`          | List of caster channels with live indicators                   | New          |
| `RaceCreationForm.svelte`    | Updated creation form with pool cards and participation toggle | Modified     |
| `Leaderboard.svelte`         | Updated with player colors matching DAG dots                   | Modified     |
| `+page.svelte` (home)        | Complete rewrite with hero DAG and dashboard                   | Modified     |
| `+page.svelte` (race detail) | State-driven layout with consistent sidebar                    | Modified     |
| `+page.svelte` (manage)      | Add caster management section                                  | Modified     |

---

## 11. Implementation Order

Suggested sequencing to deliver incrementally:

### Step 1: Data Model & API

- Add `Caster` table, `color_index` on Participant, `zone_history` (JSON) on Participant
- Add `GET /api/users/search` endpoint
- Add caster CRUD endpoints (with participant/caster mutual exclusion check)
- Update race creation to handle `organizer_participates` request field (auto-add organizer as participant)
- Enforce organizer irreversibility rule (Section 3.2)
- Update WebSocket `race_state` to conditionally include/omit `graph_json`
- Add optional message-based auth on spectator WebSocket
- Store zone traversal history on `zone_entered` events

### Step 2: Metro DAG Core

- Layout algorithm (layer positioning, crossing minimization, edge routing)
- `MetroDag.svelte` base renderer (SVG, static)
- Node type visual styles (station shapes per type)
- Weight-based spacing

### Step 3: Homepage

- Hero DAG with hand-picked seed (static first, then animated)
- Drawing animation (stroke-dashoffset)
- Ghost player racing animation
- Connected user dashboard (my races, active race spotlight)
- Race list improvements (live indicator, pool info)

### Step 4: Race Detail â€” Lobby State

- Unified sidebar layout
- Participant cards with live ready states
- "+ Invite" inline search with autocomplete
- Fake blurred DAG (procedural generation from pool params)
- Caster display
- Spectator count

### Step 5: Race Detail â€” Running State

- `MetroDagLive.svelte` with real-time player dots
- Player colors (assigned at join, consistent across leaderboard and DAG)
- Leaderboard updates with colors
- Elapsed time clock
- Caster "live" indicators

### Step 6: Race Detail â€” Finished State

- Podium component
- `MetroDagResults.svelte` with player paths overlaid
- Race stats (duration, average deaths)
- Share functionality

### Step 7: Race Creation & Management

- Updated creation form (pool cards, participation toggle)
- Caster management on manage page
- Manage page polish

### Step 8: Polish & Integration

- End-to-end testing of DAG visibility across all role/state combinations
- Curate hero seed JSON for homepage (pick best topology)
- Performance optimization (large DAGs)

---

## 12. Additional Design Notes

### 12.1 Player Color Assignment

Each participant gets a unique color, consistent across the leaderboard and DAG dots.

- Colors assigned **server-side** when the participant is added to the race
- Stored as `color_index` (integer 0-7) on the `Participant` model
- Assigned as `MAX(color_index) + 1` among existing participants in the race (starts at 0 for the first participant). This avoids holes when a participant is removed and a new one joins.
- Palette (8 colors, all readable on dark backgrounds):

| Index | Name    | Hex       | Usage         |
| ----- | ------- | --------- | ------------- |
| 0     | Gold    | `#C8A44E` | First to join |
| 1     | Purple  | `#A78BFA` |               |
| 2     | Teal    | `#2DD4BF` |               |
| 3     | Rose    | `#FB7185` |               |
| 4     | Sky     | `#38BDF8` |               |
| 5     | Orange  | `#FB923C` |               |
| 6     | Lime    | `#A3E635` |               |
| 7     | Fuchsia | `#E879F9` |               |

### 12.2 Homepage Hero Seed Data

The hero DAG uses a **static JSON file bundled with the web app** (`web/src/lib/data/hero-seed.json`). This avoids an API call and works even if the server is down. The file is manually curated:

- Selected from an existing seed with interesting topology (splits, major bosses)
- `display_name` fields tweaked for maximum appeal (e.g., ending with Malenia)
- graph.json v3 format

Since speedfog already produces v3 format, this file can be generated from any real seed.

### 12.3 Responsive Layout

Desktop-first design. Mobile adaptations:

- **Homepage**: hero DAG scales down, race cards stack vertically
- **Race detail**: sidebar collapses below the main area (DAG on top, leaderboard below)
- **DAG**: horizontal scroll with pinch-to-zoom on mobile, since metro maps are inherently wide
- Minimum supported width: 375px (iPhone SE)

### 12.4 OBS Overlays (Deferred)

Existing overlay routes from Phase 1 design (`/overlay/{id}/dag`, `/overlay/{id}/leaderboard`) are not implemented yet. **Deferred to post-Phase 2** â€” the core DAG components and leaderboard must be stable first.

Target implementation:

- `/overlay/{id}/leaderboard`: transparent background, vertical leaderboard with player colors
- `/overlay/{id}/dag`: transparent background, metro DAG with live player positions

Both will reuse the same components as the main race page but with `background: transparent` and no chrome. Casters and organizers will see direct links to these on the race detail page.
